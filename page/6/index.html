<!DOCTYPE html>
<html>
	<head>
	<meta name="generator" content="Hugo 0.100.1" />
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
		
	<title>归宅部 | Home </title><link rel="icon" type="image/png" href=https://ao2233.xyz/favicon.ico /><meta id="viewport" name="viewport">

<script type="text/javascript">

(function(){

  function apply_viewport(){
    

      var ww = window.screen.width;
      var mw = 680; 
      var ratio =  ww / mw; 
      var viewport_meta_tag = document.getElementById('viewport');
      if( ww < mw){ 
        viewport_meta_tag.setAttribute('content', 'initial-scale=' + ratio + ', width=device-width');
      }
      else { 
        viewport_meta_tag.setAttribute('content', 'initial-scale=1.0, width=device-width');
      }
    
  }

  
  window.addEventListener('resize', function(){
    apply_viewport();
  });

  apply_viewport();

}());
</script>
	
	
	
	

	
	
	
	
	<script src="https://ao2233.xyz/js/feather.min.js"></script>
	
	
	
        <link href="https://ao2233.xyz/css/fonts.css" rel="stylesheet">
	

	
	
	<link rel="stylesheet" type="text/css" media="screen" href="https://ao2233.xyz/css/main.9b8e8a799f6e2e28df142ec99e798c0b6f9ea416e05cd70d7d82c6ac53d3b1c3.css" />

	
	
	
	<link rel="stylesheet" href="https://ao2233.xyz/aplayer/APlayer.min.css" >
	<script src="https://ao2233.xyz/aplayer/APlayer.min.js"></script>
	<script src="https://ao2233.xyz/dplayer/DPlayer.min.js"></script>
	<script src="https://ao2233.xyz/js/pdfobject.min.js"></script>

	<link rel="stylesheet" href="https://ao2233.xyz/js/katex.min.css" crossorigin="anonymous">
	<script defer src="https://ao2233.xyz/js/katex.min.js" crossorigin="anonymous"></script>
	<script defer src="https://ao2233.xyz/js/auto-render.min.js" crossorigin="anonymous"  onload="renderMathInElement(document.body);"></script>

	
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			renderMathInElement(document.body, {
				delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "\\[", right: "\\]", display: true},
				{left: "$", right: "$", display: false},
				{left: "\\(", right: "\\)", display: false},
				
				
				
				
				
				]
			});
		});
	</script>

	<script src="https://ao2233.xyz/js/mermaid.min.js"></script>
		
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://ao2233.xyz/css/dark.0c347dbf372552c4028878b51c7d5207c1cde76047704ef7935a61ac0a29e7d4.css"media="(prefers-color-scheme: dark)"  />
		<script>
		
		
		
		
		
		
		
		
		
		
		
		
		const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
		var config = {
			startOnLoad:true,
			flowchart:{
			useMaxWidth:true,
			htmlLabels:true,
			curve:'cardinal',
			},
			securityLevel:'loose',
		};
		var a=0;
		function darkModeHandler() {
			if (mediaQuery.matches) {
				mermaid.initialize({
					
					theme: 'dark',
					config
				});
				if (a>0){
					document.location.reload(false);
				}
				a+=1;
				console.log('深色模式')
			} else {
				mermaid.initialize({
					
					theme: 'base',
					config
				});
				if (a>0){
					document.location.reload(false);
				}
				a+=1;
				console.log('浅色模式')
			}
		}

		
		darkModeHandler()
		
		mediaQuery.addListener(darkModeHandler)

		</script>
		

	
</head>

	<body>
		<div class="content">
			<header>
	<div class="main">
		<a href="https://ao2233.xyz/">归宅部</a>
		<link rel="icon" type="image/png" href=https://ao2233.xyz/favicon.ico />
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

			<main class="list">
				<div class="site-description"><p>四月は君の嘘</p></div>
				
				
				
				
				
				<section class="list-item">
					
					<h1 class="title">动态链接库与静态链接库</a></h1>
					<time>Jan 2, 2022 <span class="draft-label">DRAFT</span> </time> 
					
					<h1 id="示例文件">示例文件</h1>
<blockquote>
<p>fun.h</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">say</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">class</span> <span class="nc">ao</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="mi">2022</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="kt">void</span> <span class="nf">print</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><blockquote>
<p>fun.cpp</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;fun.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">say</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;happy new year&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">){</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="kt">void</span> <span class="n">ao</span><span class="o">::</span><span class="n">print</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;it&#39;s &#34;</span><span class="o">&lt;&lt;</span><span class="n">year</span><span class="o">&lt;&lt;</span><span class="s">&#34;now!&#34;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>main.cpp</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;fun.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="n">ao</span> <span class="o">*</span><span class="n">i</span><span class="o">=</span><span class="k">new</span> <span class="n">ao</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">year</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">i</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">i</span><span class="o">-&gt;</span><span class="n">year</span><span class="o">=</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">year</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="n">i</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">say</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="动态库">动态库</h1>
<blockquote>
<p>动态库生成</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># -fPIC 表示使用相对地址</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">g++ fun.cpp -fPIC -shared -o libfun.so
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># or </span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">g++ -c fun.cpp
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"># 其实是由.o生成</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">g++ fun.o -fPIC -shared -o libfun.so
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># PIC</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">100: COMPARE REG1, REG2
</span></span><span class="line"><span class="ln">11</span><span class="cl">101: JUMP_IF_EQUAL CURRENT+10
</span></span><span class="line"><span class="ln">12</span><span class="cl">...
</span></span><span class="line"><span class="ln">13</span><span class="cl">111: NOP
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"># Non-PIC</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">100: COMPARE REG1, REG2
</span></span><span class="line"><span class="ln">17</span><span class="cl">101: JUMP_IF_EQUAL <span class="m">111</span>    <span class="c1"># 仅当代码地址位于100时生效</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">...
</span></span><span class="line"><span class="ln">19</span><span class="cl">111: NOP
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">-shared
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1"># Produce a shared object which can then be linked with other objects to form an executable. Not all systems support this option.  For predictable results, you must also specify the same set of options used for compilation (-fpic, -fPIC, or model suboptions) when you specify this linker option.[1]</span>
</span></span></code></pre></div><p>如果不加<code>-fPIC</code>那么程序引用该动态库时，会进行重定位，维护一份该库的副本。最好显式声明。</p>
<blockquote>
<p>静态库使用</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">g++ main.o libfun.so  <span class="c1"># 直接使用</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"># 编译器寻找 -L 包含.（当前路径） -l 引入libfun（应以libxx的形式）</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">g++ main.cpp -L. -lfun
</span></span></code></pre></div><h1 id="静态库">静态库</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 使用ar进行生成 可以一次打包多个 .o</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"># 进行压缩</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># -c 静默模式</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># -r 增量更新的方式</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">ar -cr libfun.a fun.o
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># 解压</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">ar -x libfun.a
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># 使用静态库</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">g++ main.cpp libfun.a 
</span></span><span class="line"><span class="ln">12</span><span class="cl">g++ main.o libfun.a 
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"># Cmake在FLAG加入Lib目录即可</span>
</span></span></code></pre></div><blockquote>
<p>运行</p>
</blockquote>
<p><img src="/media/pic/2022/gcc.png" alt="gcc"></p>
<p>打包过程中，动态库和程序封装在发行包中，静态库、头文件通常封装在dev包中。</p>

					
					
							
					
				</section>
				
				

<ul class="pagination">
	<span class="page-item page-prev">
	
    <a href="/page/5/" class="page-link" aria-label="Previous"><span aria-hidden="true">← Prev</span></a>
	
	</span>
	<span class="page-item page-next">
	
    <a href="/page/7/" class="page-link" aria-label="Next"><span aria-hidden="true">Next →</span></a>
	
	</span>
</ul>


			</main>
			<footer>
<hr>
<a class="soc" href="https://github.com/gohugoio/hugo" title="GitHub"><i data-feather="github"></i></a>
<a class="soc" href="https://www.bilibili.com/" title="bilibili"><i data-feather="tv"></i></a>
✔️
      2022  AO 
</footer>


<script>
      feather.replace()
</script>
		</div>
		
	</body>
</html>
